<!DOCTYPE HTML>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>elevator animation</title>
	<script type="text/javascript">

		var status = "still"
		var floor = 1;
		var targetFloor = 1;

		var showNowFloor = ()=>{
			document.getElementById("nowFloor").innerHTML = floor.toString()
		}

		window.onload = function() {

			showNowFloor()

			var canvas = document.querySelector("canvas")
			canvas.width = 640
			canvas.height = 480

			// get the 2D context from the canvas id
			const ctx = canvas.getContext("2d");

// setup the font and text rendering
			ctx.font = "32px arial";
			ctx.textAlign = "center";
			ctx.textBaseline = "middle";


// create the image object and load the image
			const upImage = {
				posX: 0, // current position of object
				posY: 0,
				speed: 3, // speed in pixels per frame (1/60th second)
				direction: 0, // direction of movement in radians 0 is at 3oclock
				image: ((img_src) => { // create and load an image (Image will take time to load
					// and may not be ready until after the code has run.
					const image = new Image;
					image.src = "./resource/uparrow.png";
					// to start move the image of the display
					image.onload = function(){
						const imageDiagonalSize = Math.sqrt(
								image.width * image.width + image.height * image.height
						)
						// upImage.posX = (canvas.width / 2) - imageDiagonalSize - Math.cos(upImage.direction) * imageDiagonalSize;
						// upImage.posX = (canvas.height / 2) - imageDiagonalSize - Math.sin(upImage.direction) * imageDiagonalSize;
						upImage.posX = 0 + 60
						upImage.posY = 0 + 40
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY);
				},
				update() {
					var mx,my; // get movement x and y
					//this.posX += (mx = Math.cos(this.direction)) * this.speed;
					//this.posY += (my = Math.sin(this.direction)) * this.speed;
					this.posX += (mx = 0) * this.speed;
					this.posY += (my = -1) * this.speed;
					// if the image moves of the screen move it to the other side
					if(mx > 0) { // if moving right
						if(this.posX > canvas.width){
							this.posX = 0-this.image.width;
						}
					}else if(mx < 0) { // if moving left
						if(this.posX + this.image.width < 0){
							this.posX = canvas.width;
						}
					}
					if(my > 0) { // if moving down
						if(this.posY >  canvas.height){
							this.posY = 0-this.image.height;
						}
					}else if(my < 0) { // if moving up
						//console.log("11111", my)
						if(this.posY + this.image.height < 0){
							this.posY = canvas.height - 100;
						}
					}
				}
			}

			const rightImage = {
				posX: 0, // current position of object
				posY: 0,
				speed: 3, // speed in pixels per frame (1/60th second)
				direction: 0, // direction of movement in radians 0 is at 3oclock
				image: (() => { // create and load an image (Image will take time to load
					// and may not be ready until after the code has run.
					const image = new Image;
					image.src = "";
					// to start move the image of the display
					image.onload = function(){
						const imageDiagonalSize = Math.sqrt(
								image.width * image.width + image.height * image.height
						)
						rightImage.posX = (canvas.width / 2) - imageDiagonalSize - Math.cos(rightImage.direction) * imageDiagonalSize;
						rightImage.posX = (canvas.height / 2) - imageDiagonalSize - Math.sin(rightImage.direction) * imageDiagonalSize;
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY);
				},
				update() {
					var mx,my; // get movement x and y
					this.posX += (mx = Math.cos(this.direction)) * this.speed;
					this.posY += (my = Math.sin(this.direction)) * this.speed;
					// if the image moves of the screen move it to the other side
					if(mx > 0) { // if moving right
						if(this.posX > canvas.width){
							this.posX = 0-this.image.width;
						}
					}else if(mx < 0) { // if moving left
						if(this.posX + this.image.width < 0){
							this.posX = canvas.width;
						}
					}
					if(my > 0) { // if moving down
						if(this.posY > canvas.height){
							this.posY = 0-this.image.height;
						}
					}else if(my < 0) { // if moving up
						if(this.posY + this.image.height < 0){
							this.posY = canvas.height;
						}
					}
				}
			}

			const stillImage = {
				posX: 0, // current position of object
				posY: 0,
				speed: 3, // speed in pixels per frame (1/60th second)
				direction: 0, // direction of movement in radians 0 is at 3oclock
				image: ((img_src) => { // create and load an image (Image will take time to load
					// and may not be ready until after the code has run.
					const image = new Image;
					image.src = "./resource/stillarrow.png";
					// to start move the image of the display
					image.onload = function () {
						// const imageDiagonalSize = Math.sqrt(
						// 		image.width * image.width + image.height * image.height
						// )
						// upImage.posX = (canvas.width / 2) - imageDiagonalSize - Math.cos(upImage.direction) * imageDiagonalSize;
						// upImage.posX = (canvas.height / 2) - imageDiagonalSize - Math.sin(upImage.direction) * imageDiagonalSize;
						stillImage.posX = 0 + 60
						stillImage.posY = 0 + 40
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY);
				},
			}

			const downImage = {
				posX: 0, // current position of object
				posY: 0,
				speed: 3, // speed in pixels per frame (1/60th second)
				direction: 0, // direction of movement in radians 0 is at 3oclock
				image: ((img_src) => { // create and load an image (Image will take time to load
					// and may not be ready until after the code has run.
					const image = new Image;
					image.src = "./resource/downarrow.png";
					// to start move the image of the display
					image.onload = function () {
						// const imageDiagonalSize = Math.sqrt(
						// 		image.width * image.width + image.height * image.height
						// )
						// upImage.posX = (canvas.width / 2) - imageDiagonalSize - Math.cos(upImage.direction) * imageDiagonalSize;
						// upImage.posX = (canvas.height / 2) - imageDiagonalSize - Math.sin(upImage.direction) * imageDiagonalSize;
						downImage.posX = 0 + 60
						downImage.posY = 0 + 40
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY);
				},
			}



			const statusText = {
				posX:0,
				posY:0,
				content: "静 止",
				contentColor: "rgba(204, 222, 171, 1)",
				draw: (ctx) => {
					ctx.font = "40px Verdana"
					ctx.fillStyle = "white"
					ctx.fillText(statusText.content, 352, 420)
				},
				update: (ctx) => {
					if (status === "up") {
						statusText.contentColor = "rgba(228, 140, 224,1)";
					}
					if (status === "still") {
						statusText.contentColor = "rgba(204, 222, 171, 1)";
					}
					if (status === "down") {
						statusText.contentColor = "rgba(113, 211, 242, 1)"
					}
					if (status === "warning") {
						statusText.contentColor = "red"
					}
					if (status !== "still") {
						if (Math.floor(performance.now()/1000) % 2 === 0) {
							ctx.fillStyle = statusText.contentColor
							ctx.shadowColor = statusText.contentColor
							ctx.shadowOffsetX = 8;
							ctx.shadowOffsetY = 4;
							ctx.shadowBlur = 10;
							ctx.fillText(statusText.content, 352, 420)
							// line in middle
							ctx.fillRect(0, 350, canvas.width, 4)
						}
					} else {
						ctx.fillStyle = statusText.contentColor
						ctx.fillRect(0, 350, canvas.width, 4)
						if (Math.floor(performance.now()/1000) % 2 === 0) {
							ctx.shadowColor = statusText.contentColor
							ctx.shadowOffsetX = 8;
							ctx.shadowOffsetY = 4;
							ctx.shadowBlur = 10;
							ctx.fillText(statusText.content, 352, 420)
						}
					}

				}
			}

			const testGif = {
				posX: 0,
				posY: 0,
				speed: 3,
				image: (() => { // create and load an image (Image will take time to load
					// and may not be ready until after the code has run.
					const image = new Image;
					image.src = "./resource/bubble_still.gif";
					// to start move the image of the display
					image.onload = function(){
						testGif.posX = 40;
						testGif.posY = 10
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY);
				},
			}

			const bottomIconOne = {
				posX:0,
				posY:0,
				speed: 0,
				direction: 0,
				image: (() => {
					const image = new Image;
					image.src = "./resource/example_bottom_icon.png"
					image.onload = function() {
						bottomIconOne.posX = 20
						bottomIconOne.posY = 379
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY)
				}
			}

			const NoSmokingIcon = {
				image: (() => {
					const image = new Image;
					image.src = "./resource/no_smoking.png"
					image.onload = function() {
						NoSmokingIcon.posX = 14
						NoSmokingIcon.posY = 382
					}
					return image;
				})(),
				draw(ctx) {
					ctx.drawImage(this.image, this.posX, this.posY, 210, 70)
				}
			}

			// write clock
			const clock = {
				hourNumber: "00",
				minuteNumber: "00",
				showSecond: ":",
				draw: (ctx) => {
					ctx.fillText(this.hourNumber, 470, 422)
					ctx.fillText(this.showSecond, 520, 416)
					ctx.fillText(this.minuteNumber, 570, 422)
				},
				update: (ctx) => {
					let dt = new Date()
					if (dt.getHours() < 10) {
						this.hourNumber = "0"+dt.getHours()
					} else {
						this.hourNumber = dt.getHours()
					}
					if (dt.getMinutes() < 10) {
						this.minuteNumber = "0" + dt.getMinutes()
					} else {
						this.minuteNumber = dt.getMinutes()
					}
					if (Math.floor(performance.now()/1000) % 2 === 0) {
						this.showSecond = " "
					} else {
						this.showSecond = ":"
					}
				}
			}


			function mainLoop() {


				let backgroundColor = "rgba(23, 23, 23, 1)"
				let objectColor = "rgba(193, 254, 255, 0.75)"
				// clear the canvas
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.fillStyle = backgroundColor;
				ctx.fillRect(0,0, canvas.width, canvas.height)

				// floor number
				ctx.font="320px serif"
				ctx.shadowColor = "rgba(200,221,110,0.9)"
				ctx.fillStyle = "white"
				ctx.shadowOffsetX = 0;
				ctx.shadowOffsetY = 0;
				ctx.shadowBlur = 20;
				let floorShow = "01"
				if (floor < 10) {
					floorShow = "0" + floor.toString();
				} else {
					floorShow = floor.toString()
				}
				ctx.fillText(floorShow, 440, 190)



				// bottom icons
				ctx.fillStyle = backgroundColor
				ctx.shadowColor = backgroundColor
				ctx.shadowBlur = 0
				if (NoSmokingIcon.image.complete) {
					NoSmokingIcon.draw(ctx)
				}

				// clock
				//ctx.strokeStyle = objectColor
				//ctx.strokeRect(425, 380, 190, 75)

				ctx.fillStyle = objectColor
				ctx.font = "65px serif"
				clock.draw(ctx)
				clock.update(ctx)

				// status text


				// test
				//testGif.draw(ctx)


				// up arrow
				if (status === "still") {
					if (stillImage.image.complete) {
						stillImage.draw(ctx)
					}
					statusText.content = "静 止";
					statusText.draw(ctx)
					statusText.update(ctx)
				}

				if (status === "up") {
					if (upImage.image.complete) {
						upImage.draw(ctx)
					}
					statusText.content = "上 升";
					statusText.draw(ctx)
					statusText.update(ctx)
				}

				if (status === "down") {
					if (downImage.image.complete) {
						downImage.draw(ctx)
					}
					statusText.content = "下 降";
					statusText.draw(ctx)
					statusText.update(ctx)
				}

				if (status === "warning") {
					if (stillImage.image.complete) {
						stillImage.draw(ctx)
					}
					statusText.content = "错 误";
					statusText.draw(ctx)
					statusText.update(ctx)
				}
				// if(upImage.image.complete) { // wait for image to load
				// 	//upImage.update();
				// 	upImage.draw(ctx);
				// }else{ // some feedback to say the image is loading
				// 	ctx.fillText("Loading image..",canvas.width / 2, canvas.height / 2);
				// }
				// request the next frame
				requestAnimationFrame(mainLoop);
			}
// request the first frame
			requestAnimationFrame(mainLoop);


			// dom action





		}

		var upaction = function() {
			targetFloor = parseInt(document.getElementById("upTargetFloor").value);
			if (targetFloor < 1 || targetFloor <= floor) {
				status = "warning"
			} else {
				status = "up"
				document.getElementById("status_img").setAttribute("src", "./resource/bubble_up_pink.gif")
				window.upInterval = setInterval(()=>{
					if (floor < targetFloor) {
						floor++
					}
					else {
						stillaction()
					}
				}, 3000)
			}
		}

		var downaction = function() {
			targetFloor = parseInt(document.getElementById("downTargetFloor").value);
			if (targetFloor < 1 || targetFloor >= floor) {
				status = "warning"
			} else {
				status = "down"
				document.getElementById("status_img").setAttribute("src", "./resource/bubble_down_no1.gif")
				window.downInterval = setInterval(()=>{
					if (floor > targetFloor) {
						floor--
					}
					else {
						stillaction()
					}
				}, 3000)
			}

		}

		var stillaction = function() {
			if (window.downInterval !== undefined && window.downInterval !== "undefined") {
				clearInterval(window.downInterval)
			}
			if (window.upInterval !== undefined && window.upInterval !== "undefined") {
				clearInterval(window.upInterval)
			}
			showNowFloor()
			status = "still"
			document.getElementById("status_img").setAttribute("src", "./resource/bubble_still.gif")
		}

	</script>
</head>
<body style="margin: 0; padding: 0">

<div style="z-index:11;position:absolute; top: 300px; left: 160px; width: 640px; height: 480px;">
	<img id="status_img" src="resource/bubble_still.gif" alt="statusimg" style="height: 180px;"/>
</div>

<div id="canvas" style="z-index: 999">
	<canvas style="z-index: 999"></canvas>
</div>

<div style="margin-bottom: 1em">
	<button onclick="stillaction()">静止</button>
	当前楼层: <span id="nowFloor"></span>
</div>
<div style="margin-bottom: 1em">
	<button onclick="upaction()">上升</button>到 <input id="upTargetFloor" type="text" value="22">楼
</div>
<div>
	<button onclick="downaction()">下降</button>到 <input id="downTargetFloor" type="text" value="1">楼
</div>

</body>
</html>
